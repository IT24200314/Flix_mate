<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlixMate - Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Navigation -->
  <div id="navbar-container"></div>
  
  <div class="container mt-5">
    <div class="row">
      <div class="col-lg-4">
        <div class="card">
          <div class="card-body text-center">
            <div class="mb-3">
              <i class="fas fa-user-circle fa-5x text-accent"></i>
            </div>
            <h4 id="user-name">Loading...</h4>
            <p class="text-muted" id="user-email">Loading...</p>
            <span class="badge" id="user-status">Loading...</span>
          </div>
        </div>
        
        <div class="card mt-3">
          <div class="card-body">
            <h6><i class="fas fa-chart-bar me-2"></i>Quick Stats</h6>
            <div class="row text-center">
              <div class="col-6">
                <h5 id="total-bookings">0</h5>
                <small class="text-muted">Bookings</small>
              </div>
              <div class="col-6">
                <h5 id="total-reviews">0</h5>
                <small class="text-muted">Reviews</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-8">
        <div class="card">
          <div class="card-body">
            <h5><i class="fas fa-edit me-2"></i>Edit Profile</h5>
            <form id="profile-form">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="profile-name" class="form-label">Full Name</label>
                  <input type="text" class="form-control" id="profile-name" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="profile-email" class="form-label">Email</label>
                  <input type="email" class="form-control" id="profile-email" readonly>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="profile-phone" class="form-label">Phone Number</label>
                  <input type="tel" class="form-control" id="profile-phone">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="profile-status" class="form-label">Account Type</label>
                  <select class="form-select" id="profile-status" disabled>
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                  </select>
                </div>
              </div>
              
              <button type="submit" class="btn" id="update-btn">
                <i class="fas fa-save me-2"></i>Update Profile
              </button>
            </form>
          </div>
        </div>
        
        <div class="card mt-3">
          <div class="card-body">
            <h5><i class="fas fa-ticket-alt me-2"></i>Recent Bookings</h5>
            <div id="bookings-list">
              <div class="text-center text-muted">
                <i class="fas fa-ticket-alt fa-3x mb-3"></i>
                <p>No bookings found</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="script.js"></script>
  <script>
    // Load navigation
    async function loadNavigation() {
      try {
        const response = await fetch('navigation.html');
        const html = await response.text();
        document.getElementById('navbar-container').innerHTML = html;
      } catch (error) {
        console.error('Error loading navigation:', error);
      }
    }

    // Load user profile
    document.addEventListener('DOMContentLoaded', () => {
      loadNavigation();
      loadUserProfile();
      loadUserBookings();
    });

    async function loadUserProfile() {
      try {
        const profile = await apiCall('/profile', 'GET', null, true);
        
        document.getElementById('user-name').textContent = profile.userName || 'Unknown User';
        document.getElementById('user-email').textContent = profile.email || 'No email';
        document.getElementById('user-status').textContent = profile.statusName || 'user';
        
        // Update form fields
        document.getElementById('profile-name').value = profile.userName || '';
        document.getElementById('profile-email').value = profile.email || '';
        document.getElementById('profile-phone').value = profile.phone || '';
        document.getElementById('profile-status').value = profile.statusName || 'user';
        
        // Update status badge color
        const statusBadge = document.getElementById('user-status');
        statusBadge.className = 'badge';
        if (profile.statusName === 'admin') {
          statusBadge.classList.add('bg-danger');
        } else {
          statusBadge.classList.add('bg-primary');
        }
        
      } catch (error) {
        console.error('Error loading profile:', error);
        showAlert('error', 'Failed to load profile. Please login again.');
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 2000);
      }
    }

    async function loadUserBookings() {
      try {
        const bookings = await apiCall('/bookings/user', 'GET', null, true);
        const bookingsList = document.getElementById('bookings-list');
        
        if (bookings.length === 0) {
          bookingsList.innerHTML = `
            <div class="text-center text-muted">
              <i class="fas fa-ticket-alt fa-3x mb-3"></i>
              <p>No bookings found</p>
            </div>
          `;
          return;
        }
        
        bookingsList.innerHTML = bookings.map(booking => `
          <div class="card mb-2">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-6">
                  <h6 class="mb-1">Booking #${booking.bookingId}</h6>
                  <small class="text-muted">${formatDate(booking.bookingDate)}</small>
                </div>
                <div class="col-md-3">
                  <span class="badge bg-primary">${booking.seats?.length || 0} seats</span>
                </div>
                <div class="col-md-3 text-end">
                  <strong>${formatCurrency(booking.totalAmount || 0)}</strong>
                </div>
              </div>
            </div>
          </div>
        `).join('');
        
        // Update stats
        document.getElementById('total-bookings').textContent = bookings.length;
        
      } catch (error) {
        console.error('Error loading bookings:', error);
        showAlert('error', 'Failed to load bookings');
      }
    }

    // Handle profile update
    document.getElementById('profile-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const updateBtn = document.getElementById('update-btn');
      const originalText = updateBtn.innerHTML;
      
      updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
      updateBtn.disabled = true;
      
      try {
        const profileData = {
          userName: document.getElementById('profile-name').value,
          phone: document.getElementById('profile-phone').value
        };
        
        await apiCall('/profile', 'PUT', profileData, true);
        showAlert('success', 'Profile updated successfully!');
        
        // Reload profile data
        loadUserProfile();
        
      } catch (error) {
        console.error('Error updating profile:', error);
        showAlert('error', 'Failed to update profile');
      } finally {
        updateBtn.innerHTML = originalText;
        updateBtn.disabled = false;
      }
    });
  </script>
</body>
</html>