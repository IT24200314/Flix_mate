<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlixMate - Payment</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  
  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card">
          <div class="card-body">
            <h2 class="text-center mb-4">
              <i class="fas fa-credit-card me-2"></i>Payment Details
            </h2>
            
            <div id="booking-summary" class="mb-4">
              <!-- Booking summary will be loaded here -->
            </div>
            
            <form id="payment-form">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="card-number" class="form-label">Card Number</label>
                  <input type="text" class="form-control" id="card-number" placeholder="1234 5678 9012 3456" required>
                </div>
                <div class="col-md-3 mb-3">
                  <label for="expiry-date" class="form-label">Expiry Date</label>
                  <input type="text" class="form-control" id="expiry-date" placeholder="MM/YY" required>
                </div>
                <div class="col-md-3 mb-3">
                  <label for="cvv" class="form-label">CVV</label>
                  <input type="text" class="form-control" id="cvv" placeholder="123" required>
                </div>
              </div>
              
              <div class="mb-3">
                <label for="cardholder-name" class="form-label">Cardholder Name</label>
                <input type="text" class="form-control" id="cardholder-name" placeholder="John Doe" required>
              </div>
              
              <div class="mb-3">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="email" placeholder="john@example.com" required>
              </div>
              
              <div class="d-flex justify-content-between">
                <a href="booking.html" class="btn btn-outline">
                  <i class="fas fa-arrow-left me-2"></i>Back to Booking
                </a>
                <button type="submit" class="btn" id="pay-btn">
                  <i class="fas fa-lock me-2"></i>Pay Now
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="script.js"></script>
  <script>
    // Load booking data from session storage
    let bookingData = {};

    document.addEventListener('DOMContentLoaded', () => {
      bookingData = JSON.parse(sessionStorage.getItem('bookingData') || '{}');

      if (Array.isArray(bookingData.selectedSeats) && bookingData.selectedSeats.length > 0) {
        const seatPrice = Number(bookingData.seatPrice) || 0;
        bookingData.totalAmount = Number(bookingData.totalAmount) || seatPrice * bookingData.selectedSeats.length;
        bookingData.seatIds = (bookingData.seatIds || [])
          .map(id => (typeof id === 'number' ? id : Number(id)))
          .filter(Number.isFinite);
        const numericShowtimeId = Number(bookingData.showtimeId);
        if (!Number.isNaN(numericShowtimeId)) {
          bookingData.showtimeId = numericShowtimeId;
        }
      }

      loadBookingSummary();
    });

    function loadBookingSummary() {
      const summaryDiv = document.getElementById('booking-summary');
      
      if (!bookingData.selectedSeats || bookingData.selectedSeats.length === 0) {
        summaryDiv.innerHTML = `
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            No booking data found. Please go back to select seats.
          </div>
        `;
        return;
      }
      
      summaryDiv.innerHTML = `
        <div class="card">
          <div class="card-body">
            <h5>Booking Summary</h5>
            <div class="row">
              <div class="col-md-6">
                <p><strong>Selected Seats:</strong> ${bookingData.selectedSeats.map(seat => seat.row + seat.number).join(', ')}</p>
                <p><strong>Number of Seats:</strong> ${bookingData.selectedSeats.length}</p>
              </div>
              <div class="col-md-6">
                <p><strong>Price per Seat:</strong> ${formatCurrency(bookingData.seatPrice || 10)}</p>
                <p><strong>Total Amount:</strong> ${formatCurrency(bookingData.totalAmount || 0)}</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Handle payment form submission
    document.getElementById('payment-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const payBtn = document.getElementById('pay-btn');
      
      if (!bookingData || !bookingData.showtimeId || !Array.isArray(bookingData.seatIds) || bookingData.seatIds.length === 0) {
        showAlert('error', 'Booking details are missing. Please return to seat selection.');
        return;
      }

      const amountToCharge = Number(bookingData.totalAmount) || 0;
      if (amountToCharge <= 0) {
        showAlert('error', 'Total amount is invalid. Please return to seat selection.');
        return;
      }

      const originalText = payBtn.innerHTML;
      
      payBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
      payBtn.disabled = true;
      
      try {
        const bookingResponse = await apiCall(`/bookings/${bookingData.showtimeId}`, 'POST', bookingData.seatIds, true);
        
        if (bookingResponse && (bookingResponse.bookingId || bookingResponse.booking_id)) {
          const bookingId = bookingResponse.bookingId || bookingResponse.booking_id;
          bookingData.bookingId = bookingId;
          sessionStorage.setItem('bookingData', JSON.stringify(bookingData));

          const paymentData = {
            bookingId: bookingId,
            paymentMethod: 'Credit Card',
            amount: amountToCharge
          };
          
          try {
            await apiCall('/payments', 'POST', paymentData, true);
          } catch (paymentError) {
            console.warn('Payment record creation failed:', paymentError);
          }
          
          showAlert('success', 'Payment successful! Your tickets have been booked.');
          
          sessionStorage.removeItem('bookingData');
          
          setTimeout(() => {
            window.location.href = 'profile.html';
          }, 2000);
        } else {
          throw new Error('Failed to create booking');
        }
        
      } catch (error) {
        console.error('Payment error:', error);
        
        // Provide more specific error messages
        let errorMessage = 'Payment failed. Please try again.';
        
        if (error.message.includes('API Error 500')) {
          errorMessage = 'Server error occurred. Please try again later.';
        } else if (error.message.includes('API Error 400')) {
          if (error.message.includes('FOREIGN KEY constraint')) {
            errorMessage = 'Database error: Table name mismatch. Please contact support.';
          } else if (error.message.includes('could not execute statement')) {
            errorMessage = 'Database execution error. Please try again.';
          } else {
            errorMessage = 'Invalid booking data. Please return to seat selection.';
          }
        } else if (error.message.includes('API Error 404')) {
          errorMessage = 'Showtime not found. Please select a different showtime.';
        } else if (error.message.includes('API Error 409')) {
          errorMessage = 'Seats are no longer available. Please select different seats.';
        } else if (error.message.includes('FOREIGN KEY constraint')) {
          errorMessage = 'Database constraint error. Please contact support.';
        } else if (error.message.includes('show_times')) {
          errorMessage = 'Database table name mismatch. Please contact support.';
        } else if (error.message.includes('body stream already read')) {
          errorMessage = 'Network error occurred. Please try again.';
        } else if (error.message) {
          errorMessage = `Payment failed: ${error.message}`;
        }
        
        showAlert('error', errorMessage);
      } finally {
        payBtn.innerHTML = originalText;
        payBtn.disabled = false;
      }
    });
    // Format card number input
    document.getElementById('card-number').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
      let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
      e.target.value = formattedValue;
    });

    // Format expiry date input
    document.getElementById('expiry-date').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length >= 2) {
        value = value.substring(0, 2) + '/' + value.substring(2, 4);
      }
      e.target.value = value;
    });

    // Format CVV input
    document.getElementById('cvv').addEventListener('input', function(e) {
      e.target.value = e.target.value.replace(/\D/g, '').substring(0, 3);
    });
  </script>
</body>
</html>