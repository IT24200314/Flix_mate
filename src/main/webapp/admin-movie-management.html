<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlixMate - Movie Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <i class="fas fa-film me-2"></i>FlixMate Admin
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="admin-movie-management.html">Movie Management</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="admin.html">Admin Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="login.html">Logout</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-5">
    <!-- Header Section -->
    <div class="row mb-5">
      <div class="col-12">
        <h1 class="section-title">
          <i class="fas fa-film me-3"></i>Movie Management
        </h1>
        <p class="text-muted fs-5">Manage movie listings, showtimes, and seat bookings</p>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-5" id="statistics-cards">
      <div class="col-md-3 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <i class="fas fa-film fa-2x text-accent mb-3"></i>
            <h5 class="card-title">Total Movies</h5>
            <h3 class="text-accent" id="total-movies">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <i class="fas fa-clock fa-2x text-accent mb-3"></i>
            <h5 class="card-title">Total Showtimes</h5>
            <h3 class="text-accent" id="total-showtimes">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <i class="fas fa-ticket-alt fa-2x text-accent mb-3"></i>
            <h5 class="card-title">Total Bookings</h5>
            <h3 class="text-accent" id="total-bookings">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <i class="fas fa-chart-line fa-2x text-accent mb-3"></i>
            <h5 class="card-title">Active Movies</h5>
            <h3 class="text-accent" id="active-movies">-</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <h3><i class="fas fa-list me-2"></i>Movies</h3>
          <div>
            <button class="btn btn-accent me-2" onclick="showAddMovieModal()">
              <i class="fas fa-plus me-2"></i>Add Movie
            </button>
            <button class="btn btn-outline" onclick="loadMovies()">
              <i class="fas fa-refresh me-2"></i>Refresh
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Movies Table -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <div id="loading" class="text-center py-4" style="display: none;">
              <div class="spinner-border text-accent" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading movies...</p>
            </div>
            
            <div id="movies-table" style="display: none;">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Title</th>
                      <th>Genre</th>
                      <th>Duration</th>
                      <th>Language</th>
                      <th>Director</th>
                      <th>Release Year</th>
                      <th>Showtimes</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="movies-tbody">
                    <!-- Movies will be loaded here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Movie Modal -->
  <div class="modal fade" id="movieModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="movieModalTitle">
            <i class="fas fa-film me-2"></i>Add Movie
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="movieForm">
            <input type="hidden" id="movieId" name="movieId">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="title" class="form-label">Title *</label>
                <input type="text" class="form-control" id="title" name="title" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="genre" class="form-label">Genre *</label>
                <select class="form-select" id="genre" name="genre" required>
                  <option value="">Select Genre</option>
                  <option value="Action">Action</option>
                  <option value="Comedy">Comedy</option>
                  <option value="Drama">Drama</option>
                  <option value="Horror">Horror</option>
                  <option value="Sci-Fi">Sci-Fi</option>
                  <option value="Romance">Romance</option>
                  <option value="Thriller">Thriller</option>
                  <option value="Adventure">Adventure</option>
                  <option value="Fantasy">Fantasy</option>
                  <option value="Animation">Animation</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="duration" class="form-label">Duration (minutes) *</label>
                <input type="number" class="form-control" id="duration" name="duration" required min="1">
              </div>
              <div class="col-md-4 mb-3">
                <label for="language" class="form-label">Language</label>
                <input type="text" class="form-control" id="language" name="language" value="English">
              </div>
              <div class="col-md-4 mb-3">
                <label for="releaseYear" class="form-label">Release Year</label>
                <input type="number" class="form-control" id="releaseYear" name="releaseYear" value="2025" min="1900" max="2030">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="director" class="form-label">Director</label>
                <input type="text" class="form-control" id="director" name="director">
              </div>
              <div class="col-md-6 mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-accent" onclick="saveMovie()">
            <i class="fas fa-save me-2"></i>Save Movie
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Showtime Management Modal -->
  <div class="modal fade" id="showtimeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-clock me-2"></i>Manage Showtimes
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="showtime-content">
            <!-- Showtime content will be loaded here -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Seat Booking View Modal -->
  <div class="modal fade" id="seatBookingModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-chair me-2"></i>Seat Bookings
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="seat-booking-content">
            <!-- Seat booking content will be loaded here -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="script.js"></script>
  <script>
    let movies = [];
    let currentMovieId = null;

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      checkAdminAuth();
    });

    // Check if user is admin
    function checkAdminAuth() {
      if (!currentUser || currentUser.role !== 'ADMIN') {
        showAlert('error', 'Access denied. Admin privileges required.');
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 2000);
        return;
      }
      
      // User is admin, proceed with loading
      loadStatistics();
      loadMovies();
    }

    // Load statistics
    async function loadStatistics() {
      try {
        const response = await apiCall('/admin/movies/statistics', 'GET', null, true);
        document.getElementById('total-movies').textContent = response.totalMovies || 0;
        document.getElementById('total-showtimes').textContent = response.totalShowtimes || 0;
        document.getElementById('total-bookings').textContent = response.totalBookings || 0;
        document.getElementById('active-movies').textContent = response.totalMovies || 0;
      } catch (error) {
        console.error('Error loading statistics:', error);
        if (error.message.includes('403')) {
          showAlert('error', 'Access denied. Admin privileges required.');
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
        } else {
          showAlert('error', 'Failed to load statistics: ' + error.message);
        }
      }
    }

    // Load movies
    async function loadMovies() {
      try {
        showLoading(true);
        const response = await apiCall('/admin/movies', 'GET', null, true);
        movies = response;
        displayMovies(movies);
        showLoading(false);
      } catch (error) {
        console.error('Error loading movies:', error);
        if (error.message.includes('403')) {
          showAlert('error', 'Access denied. Admin privileges required.');
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
        } else {
          showAlert('error', 'Failed to load movies: ' + error.message);
        }
        showLoading(false);
      }
    }

    // Display movies in table
    function displayMovies(moviesList) {
      const tbody = document.getElementById('movies-tbody');
      tbody.innerHTML = '';

      if (moviesList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No movies found</td></tr>';
        return;
      }

      moviesList.forEach(movie => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${movie.title || 'N/A'}</strong></td>
          <td><span class="badge bg-secondary">${movie.genre || 'N/A'}</span></td>
          <td>${movie.duration || 0} min</td>
          <td>${movie.language || 'English'}</td>
          <td>${movie.director || 'N/A'}</td>
          <td>${movie.releaseYear || 'N/A'}</td>
          <td>
            <button class="btn btn-sm btn-outline" onclick="manageShowtimes(${movie.movieId})">
              <i class="fas fa-clock me-1"></i>Manage
            </button>
          </td>
          <td>
            <div class="btn-group" role="group">
              <button class="btn btn-sm btn-outline" onclick="editMovie(${movie.movieId})" title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-outline" onclick="viewMovieStats(${movie.movieId})" title="Statistics">
                <i class="fas fa-chart-bar"></i>
              </button>
              <button class="btn btn-sm btn-outline" onclick="archiveMovie(${movie.movieId})" title="Archive">
                <i class="fas fa-archive"></i>
              </button>
              <button class="btn btn-sm btn-outline" onclick="deleteMovie(${movie.movieId})" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });

      document.getElementById('movies-table').style.display = 'block';
    }

    // Show loading state
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
      document.getElementById('movies-table').style.display = show ? 'none' : 'block';
    }

    // Show add movie modal
    function showAddMovieModal() {
      currentMovieId = null;
      document.getElementById('movieModalTitle').innerHTML = '<i class="fas fa-plus me-2"></i>Add Movie';
      document.getElementById('movieForm').reset();
      document.getElementById('movieId').value = '';
      new bootstrap.Modal(document.getElementById('movieModal')).show();
    }

    // Edit movie
    function editMovie(movieId) {
      const movie = movies.find(m => m.movieId === movieId);
      if (!movie) return;

      currentMovieId = movieId;
      document.getElementById('movieModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Movie';
      document.getElementById('movieId').value = movie.movieId;
      document.getElementById('title').value = movie.title || '';
      document.getElementById('genre').value = movie.genre || '';
      document.getElementById('duration').value = movie.duration || '';
      document.getElementById('language').value = movie.language || 'English';
      document.getElementById('director').value = movie.director || '';
      document.getElementById('description').value = movie.description || '';
      document.getElementById('releaseYear').value = movie.releaseYear || 2025;
      new bootstrap.Modal(document.getElementById('movieModal')).show();
    }

    // Save movie
    async function saveMovie() {
      try {
        const form = document.getElementById('movieForm');
        const formData = new FormData(form);
        const movieData = Object.fromEntries(formData.entries());
        
        // Validate required fields
        if (!movieData.title || movieData.title.trim() === '') {
          showAlert('error', 'Movie title is required');
          return;
        }
        if (!movieData.genre || movieData.genre.trim() === '') {
          showAlert('error', 'Movie genre is required');
          return;
        }
        if (!movieData.duration || isNaN(parseInt(movieData.duration)) || parseInt(movieData.duration) <= 0) {
          showAlert('error', 'Valid duration is required');
          return;
        }
        
        // Convert duration to number
        movieData.duration = parseInt(movieData.duration);
        movieData.releaseYear = parseInt(movieData.releaseYear);

        let response;
        if (currentMovieId) {
          response = await apiCall(`/admin/movies/${currentMovieId}`, 'PUT', movieData, true);
          showAlert('success', 'Movie updated successfully');
        } else {
          response = await apiCall('/admin/movies', 'POST', movieData, true);
          showAlert('success', 'Movie created successfully');
        }

        bootstrap.Modal.getInstance(document.getElementById('movieModal')).hide();
        loadMovies();
        loadStatistics();
      } catch (error) {
        console.error('Error saving movie:', error);
        if (error.message.includes('403')) {
          showAlert('error', 'Access denied. Admin privileges required.');
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
        } else if (error.message.includes('400')) {
          showAlert('error', 'Invalid data. Please check all fields and try again.');
        } else if (error.message.includes('500')) {
          showAlert('error', 'Server error. Please try again later.');
        } else {
          showAlert('error', 'Failed to save movie: ' + error.message);
        }
      }
    }

    // Delete movie
    async function deleteMovie(movieId) {
      if (!confirm('Are you sure you want to delete this movie? This will also delete all associated showtimes and remove any related bookings. This action cannot be undone.')) {
        return;
      }

      try {
        // Show loading indicator
        showAlert('info', 'Deleting movie and cleaning up associated data...');
        
        await apiCall(`/admin/movies/${movieId}`, 'DELETE', null, true);
        showAlert('success', 'Movie deleted successfully along with all associated showtimes and bookings');
        loadMovies();
        loadStatistics();
      } catch (error) {
        console.error('Error deleting movie:', error);
        if (error.message.includes('403')) {
          showAlert('error', 'Access denied. Admin privileges required.');
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
        } else if (error.message.includes('400')) {
          showAlert('error', 'Cannot delete movie. Please check the error details and try again.');
        } else if (error.message.includes('500')) {
          showAlert('error', 'Server error. Please try again later.');
        } else {
          showAlert('error', 'Failed to delete movie: ' + error.message);
        }
      }
    }

    // Archive movie
    async function archiveMovie(movieId) {
      if (!confirm('Are you sure you want to archive this movie?')) {
        return;
      }

      try {
        await apiCall(`/admin/movies/${movieId}/archive`, 'PUT', null, true);
        showAlert('success', 'Movie archived successfully');
        loadMovies();
        loadStatistics();
      } catch (error) {
        console.error('Error archiving movie:', error);
        if (error.message.includes('403')) {
          showAlert('error', 'Access denied. Admin privileges required.');
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
        } else if (error.message.includes('400')) {
          showAlert('error', 'Cannot archive movie. Please try again.');
        } else if (error.message.includes('500')) {
          showAlert('error', 'Server error. Please try again later.');
        } else {
          showAlert('error', 'Failed to archive movie: ' + error.message);
        }
      }
    }

    // Manage showtimes
    async function manageShowtimes(movieId) {
      try {
        const response = await apiCall(`/admin/movies/${movieId}/showtimes`, 'GET', null, true);
        const movie = movies.find(m => m.movieId === movieId);
        
        let content = `
          <h6><i class="fas fa-film me-2"></i>${movie.title}</h6>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">Showtimes for this movie</span>
            <button class="btn btn-sm btn-accent" onclick="addShowtime(${movieId})">
              <i class="fas fa-plus me-1"></i>Add Showtime
            </button>
          </div>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Start Time</th>
                  <th>End Time</th>
                  <th>Price</th>
                  <th>Hall</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
        `;

        if (response.length === 0) {
          content += '<tr><td colspan="5" class="text-center text-muted">No showtimes found</td></tr>';
        } else {
          response.forEach(showtime => {
            content += `
              <tr>
                <td>${formatDate(showtime.startTime)}</td>
                <td>${formatDate(showtime.endTime)}</td>
                <td>$${showtime.price}</td>
                <td>Hall ${showtime.cinemaHall?.hallId || 'N/A'}</td>
                <td>
                  <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline" onclick="viewSeatBookings(${showtime.showtimeId})" title="View Bookings">
                      <i class="fas fa-chair"></i>
                    </button>
                    <button class="btn btn-sm btn-outline" onclick="editShowtime(${showtime.showtimeId})" title="Edit">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline" onclick="deleteShowtime(${showtime.showtimeId})" title="Delete">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            `;
          });
        }

        content += `
              </tbody>
            </table>
          </div>
        `;

        document.getElementById('showtime-content').innerHTML = content;
        new bootstrap.Modal(document.getElementById('showtimeModal')).show();
      } catch (error) {
        console.error('Error loading showtimes:', error);
        showAlert('error', 'Failed to load showtimes');
      }
    }

    // View seat bookings
    async function viewSeatBookings(showtimeId) {
      try {
        const response = await apiCall(`/admin/movies/showtimes/${showtimeId}/bookings`, 'GET', null, true);
        
        let content = `
          <h6><i class="fas fa-chair me-2"></i>Seat Bookings</h6>
          <div class="row mb-3">
            <div class="col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <h5 class="text-accent">${response.totalSeats || 0}</h5>
                  <small>Total Seats</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <h5 class="text-success">${response.availableSeats || 0}</h5>
                  <small>Available</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <h5 class="text-warning">${response.bookedSeats || 0}</h5>
                  <small>Booked</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <h5 class="text-info">${response.bookings?.length || 0}</h5>
                  <small>Bookings</small>
                </div>
              </div>
            </div>
          </div>
        `;

        if (response.bookings && response.bookings.length > 0) {
          content += `
            <h6>Recent Bookings</h6>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Booking ID</th>
                    <th>User</th>
                    <th>Seats</th>
                    <th>Amount</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
          `;

          response.bookings.forEach(booking => {
            content += `
              <tr>
                <td>#${booking.bookingId}</td>
                <td>${booking.user?.email || 'N/A'}</td>
                <td>${booking.totalSeats}</td>
                <td>$${booking.totalAmount}</td>
                <td><span class="badge bg-${getStatusBadgeClass(booking.status)}">${booking.status}</span></td>
              </tr>
            `;
          });

          content += `
                </tbody>
              </table>
            </div>
          `;
        }

        document.getElementById('seat-booking-content').innerHTML = content;
        new bootstrap.Modal(document.getElementById('seatBookingModal')).show();
      } catch (error) {
        console.error('Error loading seat bookings:', error);
        showAlert('error', 'Failed to load seat bookings');
      }
    }

    // View movie statistics
    async function viewMovieStats(movieId) {
      try {
        const response = await apiCall(`/admin/movies/${movieId}/statistics`, 'GET', null, true);
        
        let content = `
          <h6><i class="fas fa-chart-bar me-2"></i>Movie Statistics</h6>
          <div class="row mb-3">
            <div class="col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <h5 class="text-accent">${response.totalShowtimes || 0}</h5>
                  <small>Showtimes</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <h5 class="text-success">${response.totalBookings || 0}</h5>
                  <small>Bookings</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <h5 class="text-warning">${response.totalSeatsBooked || 0}</h5>
                  <small>Seats Booked</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center">
                <div class="card-body">
                  <h5 class="text-info">${response.showtimes?.length || 0}</h5>
                  <small>Active Shows</small>
                </div>
              </div>
            </div>
          </div>
        `;

        document.getElementById('seat-booking-content').innerHTML = content;
        new bootstrap.Modal(document.getElementById('seatBookingModal')).show();
      } catch (error) {
        console.error('Error loading movie statistics:', error);
        showAlert('error', 'Failed to load movie statistics');
      }
    }

    // Utility functions
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      try {
        const date = new Date(dateString);
        return date.toLocaleString();
      } catch (e) {
        return dateString;
      }
    }

    function getStatusBadgeClass(status) {
      switch (status) {
        case 'CONFIRMED': return 'success';
        case 'PENDING': return 'warning';
        case 'CANCELLED': return 'danger';
        case 'UPDATED': return 'info';
        default: return 'secondary';
      }
    }
  </script>
</body>
</html>
