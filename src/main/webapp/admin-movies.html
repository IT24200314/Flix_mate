<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlixMate - Admin Movie Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="navbar-container"></div>

  <main class="page-main">
    <section class="surface stack gap-md">
      <div class="section-header">
        <div class="stack gap-xxs">
          <p class="eyebrow">Admin console</p>
          <h1 class="page-title">Movie catalogue</h1>
        </div>
        <div class="action-row">
          <button class="btn ghost" type="button" id="refreshMovies">
            <i class="fas fa-rotate me-2"></i>Refresh
          </button>
          <button class="btn primary" type="button" id="createMovieBtn">
            <i class="fas fa-plus me-2"></i>Add movie
          </button>
        </div>
      </div>
      <p class="page-subtitle mb-0">Signed in as <span id="adminIdentity">admin</span>. Select a title to manage its details, showtimes, and cinema halls.</p>
    </section>

    <section class="surface stack gap-md">
      <div class="section-header align-start">
        <div class="stack gap-xxs">
          <h2 class="section-title">Titles</h2>
          <p class="text-muted small mb-0">Search by title, genre, or director to locate movies quickly.</p>
        </div>
        <div class="stack gap-xxs">
          <input type="search" id="movieSearch" class="input" placeholder="Search movies" aria-label="Search movies">
          <span class="chip" id="movieCounter">0 titles</span>
        </div>
      </div>
      <ul class="movie-list" id="movieList">
        <li class="movie-list-item skeleton"></li>
        <li class="movie-list-item skeleton"></li>
        <li class="movie-list-item skeleton"></li>
      </ul>
    </section>
    <section class="surface stack gap-md" id="movieFormSection">
      <div class="section-header">
        <h2 class="section-title" id="movieFormHeading">Movie details</h2>
        <button class="btn ghost" type="button" id="movieClear">Clear form</button>
      </div>
      <form id="movieForm" class="stack gap-md">
        <input type="hidden" id="movieId">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Title *</label>
            <input type="text" class="input" id="movieTitle" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Genre *</label>
            <input type="text" class="input" id="movieGenre" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Director *</label>
            <input type="text" class="input" id="movieDirector" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Language *</label>
            <input type="text" class="input" id="movieLanguage" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Release year *</label>
            <input type="number" class="input" id="movieReleaseYear" min="1900" max="2099" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Duration (minutes) *</label>
            <input type="number" class="input" id="movieDuration" min="1" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Rating</label>
            <input type="text" class="input" id="movieRating" placeholder="PG-13">
          </div>
          <div class="col-12">
            <label class="form-label">Cast</label>
            <textarea class="input" id="movieCast" rows="2" placeholder="Lead actors"></textarea>
          </div>
          <div class="col-12">
            <label class="form-label">Description</label>
            <textarea class="input" id="movieDescription" rows="3" placeholder="Short synopsis"></textarea>
          </div>
          <div class="col-12">
            <label class="form-label">Trailer URL</label>
            <input type="url" class="input" id="movieTrailerUrl" placeholder="https://...">
          </div>
          <div class="col-12 d-flex align-items-center gap-2">
            <input class="form-check-input" type="checkbox" id="movieActive" checked>
            <label class="form-check-label" for="movieActive">Movie is active and visible to customers</label>
          </div>
        </div>
        <div class="action-row">
          <button class="btn primary" type="submit">
            <i class="fas fa-save me-2"></i>Save movie
          </button>
        </div>
      </form>
    </section>

    <section class="surface stack gap-md" id="showtimeSection" hidden>
      <div class="section-header align-start">
        <div class="stack gap-xxs">
          <h2 class="section-title">Showtimes</h2>
          <p class="text-muted small mb-0">Manage sessions for <span id="showtimeMovieTitle">selected movie</span>.</p>
        </div>
      </div>
      <form id="showtimeForm" class="row g-3">
        <div class="col-lg-4 col-md-6">
          <label class="form-label">Cinema hall *</label>
          <select id="showtimeHall" class="input" required>
            <option value="">Select a hall</option>
          </select>
        </div>
        <div class="col-lg-4 col-md-6">
          <label class="form-label">Start time *</label>
          <input type="datetime-local" id="showtimeStart" class="input" required>
        </div>
        <div class="col-lg-2 col-md-6">
          <label class="form-label">End time</label>
          <input type="datetime-local" id="showtimeEnd" class="input">
        </div>
        <div class="col-lg-2 col-md-6">
          <label class="form-label">Base price *</label>
          <input type="number" id="showtimePrice" class="input" min="0" step="0.01" placeholder="12.00" required>
        </div>
        <div class="col-12">
          <button class="btn primary" type="submit">
            <i class="fas fa-plus me-2"></i>Add showtime
          </button>
        </div>
      </form>
      <ul class="movie-list" id="showtimeList">
        <li class="movie-list-item muted">Select a movie to view scheduled showtimes.</li>
      </ul>
    </section>

    <section class="surface stack gap-md" id="hallSection">
      <div class="section-header align-start">
        <div class="stack gap-xxs">
          <h2 class="section-title">Cinema halls</h2>
          <p class="text-muted small mb-0">Maintain hall capacity information for showtime scheduling.</p>
        </div>
      </div>
      <form id="hallForm" class="row g-3">
        <input type="hidden" id="hallId">
        <div class="col-lg-4 col-md-6">
          <label class="form-label">Hall name *</label>
          <input type="text" class="input" id="hallName" required>
        </div>
        <div class="col-lg-4 col-md-6">
          <label class="form-label">Location</label>
          <input type="text" class="input" id="hallLocation" placeholder="Level 2, Wing B">
        </div>
        <div class="col-lg-2 col-md-6">
          <label class="form-label">Capacity *</label>
          <input type="number" class="input" id="hallCapacity" min="1" required>
        </div>
        <div class="col-lg-2 col-md-6">
          <label class="form-label">Hall type</label>
          <input type="text" class="input" id="hallType" placeholder="Standard / VIP">
        </div>
        <div class="col-12 action-row">
          <button class="btn primary" type="submit">
            <i class="fas fa-save me-2"></i>Save hall
          </button>
          <button class="btn ghost" type="button" id="hallClear">Clear</button>
        </div>
      </form>
      <ul class="movie-list" id="hallList">
        <li class="movie-list-item muted">No halls loaded.</li>
      </ul>
    </section>
  </main>

  <footer class="app-footer">
    <div class="container text-center text-muted small">
      <p class="mb-1">Looking for quick actions? Visit the <a class="link-muted" href="admin-home.html">admin home</a>.</p>
      <p class="mb-0">&copy; <span id="adminMoviesYear"></span> FlixMate.</p>
    </div>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/error-boundary.js"></script>
  <script src="script.js"></script>
  <script>
    let adminToken = null;
    const state = {
      movies: [],
      halls: [],
      showtimes: [],
      selectedMovieId: null,
      editingHallId: null
    };

    async function loadNavigation() {
      try {
        const response = await fetch('navigation.html');
        document.getElementById('navbar-container').innerHTML = await response.text();
      } catch (error) {
        console.error('Navigation load failed:', error);
      }
    }

    function guardAdmin() {
      const token = localStorage.getItem('authToken');
      const storedUser = localStorage.getItem('currentUser');

      if (!token || !storedUser) {
        showAlert('info', 'Please sign in as an administrator.');
        window.location.href = 'login.html';
        return null;
      }

      try {
        const user = JSON.parse(storedUser);
        const role = String(user.role || '').toUpperCase();
        if (!role.includes('ADMIN')) {
          window.location.href = 'user-home.html';
          return null;
        }
        document.getElementById('adminIdentity').textContent = user.email || user.userName || 'Admin';
      } catch (error) {
        console.error('Failed to parse stored user:', error);
        window.location.href = 'login.html';
        return null;
      }

      return token;
    }

    function bindEvents() {
      document.getElementById('movieForm').addEventListener('submit', handleMovieSubmit);
      document.getElementById('movieClear').addEventListener('click', () => resetMovieForm());
      document.getElementById('movieSearch').addEventListener('input', event => renderMovieList(event.target.value));
      document.getElementById('movieList').addEventListener('click', handleMovieListClick);
      document.getElementById('createMovieBtn').addEventListener('click', () => {
        state.selectedMovieId = null;
        resetMovieForm();
        document.getElementById('movieTitle').focus();
      });
      document.getElementById('refreshMovies').addEventListener('click', loadMovies);
      document.getElementById('showtimeForm').addEventListener('submit', handleShowtimeSubmit);
      document.getElementById('showtimeList').addEventListener('click', handleShowtimeListClick);
      document.getElementById('hallForm').addEventListener('submit', handleHallSubmit);
      document.getElementById('hallList').addEventListener('click', handleHallListClick);
      document.getElementById('hallClear').addEventListener('click', () => resetHallForm());
    }

    async function loadMovies() {
      const list = document.getElementById('movieList');
      list.classList.add('loading');
      list.innerHTML = '<li class="movie-list-item skeleton"></li>'.repeat(3);

      try {
        const response = await fetch('/api/admin/movies', {
          headers: { Authorization: `Bearer ${adminToken}` }
        });

        if (!response.ok) {
          throw new Error(`Unable to load movies (status ${response.status}).`);
        }

        state.movies = await response.json();
        renderMovieList();
      } catch (error) {
        console.error('Movie load failed:', error);
        list.innerHTML = '<li class="movie-list-item muted">Could not load movies.</li>';
        showAlert('error', 'Failed to load movies. Please try again.');
      } finally {
        list.classList.remove('loading');
      }
    }

    function renderMovieList(filter = '') {
      const list = document.getElementById('movieList');
      const search = filter.trim().toLowerCase();
      const filtered = state.movies.filter(movie => {
        if (!search) return true;
        const haystack = [movie.title, movie.genre, movie.director]
          .filter(Boolean)
          .map(value => value.toLowerCase())
          .join(' ');
        return haystack.includes(search);
      });

      document.getElementById('movieCounter').textContent = `${filtered.length} ${filtered.length === 1 ? 'title' : 'titles'}`;

      if (!filtered.length) {
        list.innerHTML = '<li class="movie-list-item muted">No movies match your search.</li>';
        return;
      }

      list.innerHTML = filtered
        .sort((a, b) => a.title.localeCompare(b.title))
        .map(movie => {
          const isSelected = state.selectedMovieId === movie.movieId ? 'active' : '';
          const statusChip = movie.isActive ? '<span class="chip">Active</span>' : '<span class="chip" style="background: #fee2e2; color: #b91c1c;">Inactive</span>';
          return `
            <li class="movie-list-item ${isSelected}">
              <div class="stack gap-xxs">
                <span class="movie-name" data-action="select" data-id="${movie.movieId}">${movie.title || 'Untitled movie'}</span>
                <small class="text-muted">${movie.genre || 'Unknown genre'} • ${movie.director || 'Unknown director'}</small>
              </div>
              <div class="item-actions">
                ${statusChip}
                <button class="btn ghost" type="button" data-action="edit" data-id="${movie.movieId}">
                  <i class="fas fa-pen-to-square me-1"></i>Open
                </button>
                <button class="btn icon danger" type="button" data-action="delete" data-id="${movie.movieId}">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </li>
          `;
        })
        .join('');
    }
    function handleMovieListClick(event) {
      const actionTrigger = event.target.closest('[data-action]');
      if (!actionTrigger) return;

      const movieId = Number(actionTrigger.getAttribute('data-id'));
      const action = actionTrigger.getAttribute('data-action');

      if (!movieId || Number.isNaN(movieId)) return;

      if (action === 'delete') {
        deleteMovie(movieId);
      } else {
        selectMovie(movieId);
      }
    }

    function selectMovie(movieId) {
      const movie = state.movies.find(item => item.movieId === movieId);
      if (!movie) return;

      state.selectedMovieId = movieId;
      document.getElementById('movieFormHeading').textContent = `Editing: ${movie.title}`;
      document.getElementById('movieId').value = movie.movieId;
      document.getElementById('movieTitle').value = movie.title || '';
      document.getElementById('movieGenre').value = movie.genre || '';
      document.getElementById('movieDirector').value = movie.director || '';
      document.getElementById('movieLanguage').value = movie.language || '';
      document.getElementById('movieReleaseYear').value = movie.releaseYear || '';
      document.getElementById('movieDuration').value = movie.duration || '';
      document.getElementById('movieRating').value = movie.rating || '';
      document.getElementById('movieCast').value = movie.cast || '';
      document.getElementById('movieDescription').value = movie.description || '';
      document.getElementById('movieTrailerUrl').value = movie.trailerUrl || '';
      document.getElementById('movieActive').checked = Boolean(movie.isActive);

      document.getElementById('showtimeMovieTitle').textContent = movie.title || 'Selected movie';
      document.getElementById('showtimeSection').hidden = false;
      renderMovieList(document.getElementById('movieSearch').value || '');
      loadShowtimes(movieId);
    }

    function resetMovieForm() {
      document.getElementById('movieForm').reset();
      document.getElementById('movieId').value = '';
      document.getElementById('movieActive').checked = true;
      document.getElementById('movieFormHeading').textContent = 'Movie details';
      document.getElementById('showtimeSection').hidden = true;
      state.selectedMovieId = null;
      state.showtimes = [];
      document.getElementById('showtimeList').innerHTML = '<li class="movie-list-item muted">Select a movie to view scheduled showtimes.</li>';
      renderMovieList(document.getElementById('movieSearch').value || '');
    }

    async function handleMovieSubmit(event) {
      event.preventDefault();

      const formData = {
        title: document.getElementById('movieTitle').value.trim(),
        genre: document.getElementById('movieGenre').value.trim(),
        director: document.getElementById('movieDirector').value.trim(),
        language: document.getElementById('movieLanguage').value.trim(),
        releaseYear: Number(document.getElementById('movieReleaseYear').value),
        duration: Number(document.getElementById('movieDuration').value),
        rating: document.getElementById('movieRating').value.trim(),
        cast: document.getElementById('movieCast').value.trim(),
        description: document.getElementById('movieDescription').value.trim(),
        trailerUrl: document.getElementById('movieTrailerUrl').value.trim(),
        isActive: document.getElementById('movieActive').checked
      };

      if (!formData.title || !formData.genre || !formData.director || !formData.language || !formData.releaseYear || !formData.duration) {
        showAlert('error', 'Please complete all required fields.');
        return;
      }

      const movieId = state.selectedMovieId;
      const endpoint = movieId ? `/api/admin/movies/${movieId}` : '/api/admin/movies';
      const method = movieId ? 'PUT' : 'POST';

      try {
        const response = await fetch(endpoint, {
          method,
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || 'Failed to save movie.');
        }

        const savedMovie = await response.json();
        if (movieId) {
          state.movies = state.movies.map(movie => movie.movieId === movieId ? savedMovie : movie);
          showAlert('success', 'Movie updated successfully.');
          selectMovie(savedMovie.movieId);
        } else {
          state.movies.unshift(savedMovie);
          showAlert('success', 'Movie created successfully.');
          selectMovie(savedMovie.movieId);
        }

        renderMovieList(document.getElementById('movieSearch').value || '');
      } catch (error) {
        console.error('Failed to save movie:', error);
        showAlert('error', error.message || 'Failed to save movie.');
      }
    }

    async function deleteMovie(movieId) {
      const movie = state.movies.find(item => item.movieId === movieId);
      const title = movie?.title || 'this movie';

      if (!confirm(`Delete "${title}"? This action cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch(`/api/admin/movies/${movieId}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${adminToken}` }
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || 'Failed to delete movie.');
        }

        state.movies = state.movies.filter(movie => movie.movieId !== movieId);
        showAlert('success', 'Movie removed.');
        if (state.selectedMovieId === movieId) {
          resetMovieForm();
        } else {
          renderMovieList(document.getElementById('movieSearch').value || '');
        }
      } catch (error) {
        console.error('Failed to delete movie:', error);
        showAlert('error', error.message || 'Failed to delete movie.');
      }
    }
    async function loadShowtimes(movieId) {
      const list = document.getElementById('showtimeList');
      list.classList.add('loading');
      list.innerHTML = '<li class="movie-list-item skeleton"></li>';

      try {
        const response = await fetch(`/api/admin/movies/${movieId}/showtimes`, {
          headers: { Authorization: `Bearer ${adminToken}` }
        });

        if (!response.ok) {
          throw new Error(`Unable to load showtimes (status ${response.status}).`);
        }

        state.showtimes = await response.json();
        renderShowtimes();
      } catch (error) {
        console.error('Failed to load showtimes:', error);
        list.innerHTML = '<li class="movie-list-item muted">Unable to load showtimes.</li>';
      } finally {
        list.classList.remove('loading');
      }
    }

    function renderShowtimes() {
      const list = document.getElementById('showtimeList');

      if (!state.showtimes.length) {
        list.innerHTML = '<li class="movie-list-item muted">No showtimes scheduled for this movie.</li>';
        return;
      }

      list.innerHTML = state.showtimes
        .sort((a, b) => new Date(a.startTime) - new Date(b.startTime))
        .map(showtime => {
          const start = new Date(showtime.startTime);
          const end = showtime.endTime ? new Date(showtime.endTime) : null;
          const hallName = showtime.cinemaHall?.name || 'Unknown hall';
          const price = typeof showtime.price === 'number' ? showtime.price.toFixed(2) : '—';
          return `
            <li class="movie-list-item">
              <div class="stack gap-xxs">
                <span class="movie-name">${start.toLocaleString()}</span>
                <small class="text-muted">${hallName}${end ? ` • Ends ${end.toLocaleTimeString()}` : ''}</small>
              </div>
              <div class="item-actions">
                <span class="chip">$${price}</span>
                <button class="btn icon danger" type="button" data-action="delete-showtime" data-id="${showtime.showtimeId}">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </li>
          `;
        })
        .join('');
    }

    function handleShowtimeListClick(event) {
      const trigger = event.target.closest('[data-action="delete-showtime"]');
      if (!trigger) return;
      const showtimeId = Number(trigger.getAttribute('data-id'));
      if (!showtimeId || Number.isNaN(showtimeId)) return;
      deleteShowtime(showtimeId);
    }

    async function handleShowtimeSubmit(event) {
      event.preventDefault();
      if (!state.selectedMovieId) {
        showAlert('error', 'Select a movie before adding showtimes.');
        return;
      }

      const hallId = Number(document.getElementById('showtimeHall').value);
      const startValue = document.getElementById('showtimeStart').value;
      const endValue = document.getElementById('showtimeEnd').value;
      const priceValue = document.getElementById('showtimePrice').value;

      if (!hallId || !startValue || !priceValue) {
        showAlert('error', 'Please fill in hall, start time, and price.');
        return;
      }

      const payload = {
        hallId,
        startTime: new Date(startValue).toISOString(),
        endTime: endValue ? new Date(endValue).toISOString() : null,
        price: Number(priceValue)
      };

      try {
        const response = await fetch(`/api/admin/movies/${state.selectedMovieId}/showtimes`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || 'Failed to add showtime.');
        }

        const saved = await response.json();
        state.showtimes.push(saved);
        renderShowtimes();
        document.getElementById('showtimeForm').reset();
        showAlert('success', 'Showtime added.');
      } catch (error) {
        console.error('Showtime save failed:', error);
        showAlert('error', error.message || 'Failed to add showtime.');
      }
    }

    async function deleteShowtime(showtimeId) {
      if (!confirm('Delete this showtime?')) {
        return;
      }

      try {
        const response = await fetch(`/api/admin/showtimes/${showtimeId}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${adminToken}` }
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || 'Failed to delete showtime.');
        }

        state.showtimes = state.showtimes.filter(showtime => showtime.showtimeId !== showtimeId);
        renderShowtimes();
        showAlert('success', 'Showtime deleted.');
      } catch (error) {
        console.error('Showtime delete failed:', error);
        showAlert('error', error.message || 'Failed to delete showtime.');
      }
    }
    async function loadHalls() {
      try {
        const response = await fetch('/api/admin/cinema-halls', {
          headers: { Authorization: `Bearer ${adminToken}` }
        });

        if (!response.ok) {
          throw new Error(`Unable to load halls (status ${response.status}).`);
        }

        state.halls = await response.json();
        renderHallList();
        populateHallOptions();
      } catch (error) {
        console.error('Hall load failed:', error);
        state.halls = [];
        document.getElementById('hallList').innerHTML = '<li class="movie-list-item muted">Could not load cinema halls.</li>';
        populateHallOptions();
      }
    }

    function renderHallList() {
      const list = document.getElementById('hallList');

      if (!state.halls.length) {
        list.innerHTML = '<li class="movie-list-item muted">No cinema halls configured.</li>';
        return;
      }

      list.innerHTML = state.halls
        .sort((a, b) => a.name.localeCompare(b.name))
        .map(hall => `
          <li class="movie-list-item">
            <div class="stack gap-xxs">
              <span class="movie-name">${hall.name || 'Unnamed hall'}</span>
              <small class="text-muted">Capacity ${hall.capacity || '0'}${hall.hallType ? ` • ${hall.hallType}` : ''}${hall.location ? ` • ${hall.location}` : ''}</small>
            </div>
            <div class="item-actions">
              <button class="btn ghost" type="button" data-action="edit-hall" data-id="${hall.hallId}">
                <i class="fas fa-pen-to-square me-1"></i>Edit
              </button>
              <button class="btn icon danger" type="button" data-action="delete-hall" data-id="${hall.hallId}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </li>
        `)
        .join('');
    }

    function populateHallOptions() {
      const select = document.getElementById('showtimeHall');
      const options = state.halls
        .sort((a, b) => a.name.localeCompare(b.name))
        .map(hall => `<option value="${hall.hallId}">${hall.name}</option>`)
        .join('');
      select.innerHTML = '<option value="">Select a hall</option>' + options;
    }

    function handleHallListClick(event) {
      const trigger = event.target.closest('[data-action]');
      if (!trigger) return;
      const hallId = Number(trigger.getAttribute('data-id'));
      const action = trigger.getAttribute('data-action');
      if (!hallId || Number.isNaN(hallId)) return;

      if (action === 'edit-hall') {
        editHall(hallId);
      } else if (action === 'delete-hall') {
        deleteHall(hallId);
      }
    }

    function editHall(hallId) {
      const hall = state.halls.find(item => item.hallId === hallId);
      if (!hall) return;

      state.editingHallId = hallId;
      document.getElementById('hallId').value = hall.hallId;
      document.getElementById('hallName').value = hall.name || '';
      document.getElementById('hallLocation').value = hall.location || '';
      document.getElementById('hallCapacity').value = hall.capacity || '';
      document.getElementById('hallType').value = hall.hallType || '';
      document.getElementById('hallForm').scrollIntoView({ behavior: 'smooth' });
    }

    function resetHallForm() {
      document.getElementById('hallForm').reset();
      document.getElementById('hallId').value = '';
      state.editingHallId = null;
    }

    async function handleHallSubmit(event) {
      event.preventDefault();

      const hallId = state.editingHallId;
      const payload = {
        name: document.getElementById('hallName').value.trim(),
        location: document.getElementById('hallLocation').value.trim(),
        capacity: Number(document.getElementById('hallCapacity').value),
        hallType: document.getElementById('hallType').value.trim()
      };

      if (!payload.name || !payload.capacity) {
        showAlert('error', 'Please provide a hall name and capacity.');
        return;
      }

      const endpoint = hallId ? `/api/admin/cinema-halls/${hallId}` : '/api/admin/cinema-halls';
      const method = hallId ? 'PUT' : 'POST';

      try {
        const response = await fetch(endpoint, {
          method,
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || 'Failed to save cinema hall.');
        }

        const savedHall = await response.json();
        if (hallId) {
          state.halls = state.halls.map(hall => hall.hallId === hallId ? savedHall : hall);
          showAlert('success', 'Hall updated.');
        } else {
          state.halls.push(savedHall);
          showAlert('success', 'Hall created.');
        }

        resetHallForm();
        renderHallList();
        populateHallOptions();
      } catch (error) {
        console.error('Hall save failed:', error);
        showAlert('error', error.message || 'Failed to save hall.');
      }
    }

    async function deleteHall(hallId) {
      const hall = state.halls.find(item => item.hallId === hallId);
      const name = hall?.name || 'this hall';

      if (!confirm(`Delete ${name}? This action cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch(`/api/admin/cinema-halls/${hallId}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${adminToken}` }
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || 'Failed to delete hall.');
        }

        state.halls = state.halls.filter(hall => hall.hallId !== hallId);
        showAlert('success', 'Hall removed.');
        renderHallList();
        populateHallOptions();
        if (state.editingHallId === hallId) {
          resetHallForm();
        }
      } catch (error) {
        console.error('Hall delete failed:', error);
        showAlert('error', error.message || 'Failed to delete hall.');
      }
    }
    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('adminMoviesYear').textContent = new Date().getFullYear();
      await loadNavigation();
      adminToken = guardAdmin();
      if (!adminToken) return;
      bindEvents();
      await Promise.all([loadMovies(), loadHalls()]);
    });
  </script>
</body>
</html>
