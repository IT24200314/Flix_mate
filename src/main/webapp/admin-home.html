<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlixMate — Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="navbar-container"></div>

  <main class="page-main page-main--narrow">
    <section class="surface stack gap-md">
      <div class="section-header">
        <div class="stack gap-xxs">
          <p class="eyebrow">Admin Console</p>
          <h1 class="page-title">Movie management</h1>
        </div>
        <button class="btn ghost" id="refreshMovies" type="button">
          <i class="fas fa-rotate me-2"></i>Refresh
        </button>
      </div>
      <p class="page-subtitle mb-0">Signed in as <span id="adminIdentity">admin</span>.</p>
      <p class="text-muted small mb-0">Remove titles directly or open the advanced manager for full CRUD controls.</p>
    </section>

    <section class="surface stack gap-md">
      <div class="section-header">
        <h2 class="section-title">Active movies</h2>
        <div class="action-row wrap">
          <span class="chip" id="movieCounter">0 titles</span>
          <a class="btn ghost" href="admin-movies.html">Open advanced manager</a>
        </div>
      </div>
      <ul class="movie-list" id="adminMovieList">
        <li class="movie-list-item skeleton"></li>
        <li class="movie-list-item skeleton"></li>
        <li class="movie-list-item skeleton"></li>
      </ul>
    </section>
  </main>

  <footer class="app-footer">
    <div class="container text-center text-muted small">
      <p class="mb-1">Need the classic dashboard? Head to <a class="link-muted" href="admin-movies.html">advanced movie manager</a>.</p>
      <p class="mb-0">&copy; <span id="adminFooterYear"></span> FlixMate.</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/error-boundary.js"></script>
  <script src="script.js"></script>
  <script>
    const movieList = document.getElementById('adminMovieList');
    const movieCounter = document.getElementById('movieCounter');
    const refreshButton = document.getElementById('refreshMovies');
    const adminIdentity = document.getElementById('adminIdentity');

    async function loadNavigation() {
      try {
        const response = await fetch('navigation.html');
        document.getElementById('navbar-container').innerHTML = await response.text();
      } catch (error) {
        console.error('Navigation load failed:', error);
      }
    }

    function guardAdmin() {
      const storedUser = localStorage.getItem('currentUser');
      const token = localStorage.getItem('authToken');

      if (!storedUser || !token) {
        showAlert('info', 'Admin access requires signing in.');
        window.location.href = 'login.html';
        return null;
      }

      let parsedUser;
      try {
        parsedUser = JSON.parse(storedUser);
      } catch (error) {
        console.error('Unable to parse stored admin data:', error);
        window.location.href = 'login.html';
        return null;
      }

      const normalizedRole = String(parsedUser.role || '').toUpperCase();
      if (!normalizedRole.includes('ADMIN')) {
        window.location.href = 'user-home.html';
        return null;
      }

      adminIdentity.textContent = parsedUser.email || parsedUser.userName || 'Admin';
      return token;
    }

    function renderPlaceholder(message) {
      movieList.innerHTML = `<li class="movie-list-item muted">${message}</li>`;
      movieCounter.textContent = '0 titles';
    }

    async function loadMovies() {
      const token = guardAdmin();
      if (!token) {
        return;
      }

      movieList.classList.add('loading');
      movieList.innerHTML = '<li class="movie-list-item skeleton"></li>'.repeat(3);

      try {
        const response = await fetch('/api/admin/movies', {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (response.status === 401 || response.status === 403) {
          showAlert('error', 'Admin session expired. Please sign in again.');
          window.location.href = 'login.html';
          return;
        }

        if (!response.ok) {
          throw new Error(`Request failed with status ${response.status}`);
        }

        const movies = await response.json();
        if (!Array.isArray(movies) || movies.length === 0) {
          renderPlaceholder('No movies found. Use the advanced manager to add new titles.');
          return;
        }

        movieCounter.textContent = `${movies.length} ${movies.length === 1 ? 'title' : 'titles'}`;
        movieList.innerHTML = movies
          .sort((a, b) => a.title.localeCompare(b.title))
          .map((movie) => `
            <li class="movie-list-item">
              <span class="movie-name">${movie.title || 'Untitled Movie'}</span>
              <div class="item-actions">
                <button class="btn icon danger" type="button" data-remove="${movie.movieId}">
                  <i class="fas fa-trash"></i>
                  <span>Remove</span>
                </button>
              </div>
            </li>
          `)
          .join('');
      } catch (error) {
        console.error('Failed to load movies:', error);
        renderPlaceholder('Unable to load movies right now.');
      } finally {
        movieList.classList.remove('loading');
      }
    }

    async function handleRemove(movieId, movieName) {
      const token = guardAdmin();
      if (!token) {
        return;
      }

      const confirmed = confirm(`Remove "${movieName}" from the catalogue?`);
      if (!confirmed) {
        return;
      }

      try {
        const response = await fetch(`/api/admin/movies/${movieId}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!response.ok) {
          throw new Error(`Deletion failed with status ${response.status}`);
        }

        showAlert('success', 'Movie removed successfully.');
        await loadMovies();
      } catch (error) {
        console.error('Movie removal failed:', error);
        showAlert('error', 'Could not remove the movie. Please try again.');
      }
    }

    movieList.addEventListener('click', (event) => {
      const trigger = event.target.closest('[data-remove]');
      if (!trigger) {
        return;
      }

      const movieId = trigger.getAttribute('data-remove');
      const nameNode = trigger.closest('.movie-list-item')?.querySelector('.movie-name');
      const movieName = nameNode ? nameNode.textContent.trim() : 'this movie';
      handleRemove(movieId, movieName);
    });

    refreshButton.addEventListener('click', loadMovies);

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('adminFooterYear').textContent = new Date().getFullYear();
      loadNavigation();
      loadMovies();
    });
  </script>
</body>
</html>
